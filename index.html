<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Flashcards App</title>
  <!-- Bootstrap CSS desde CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome para íconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  
  <style>
    /* =========================
       Estilos personalizados
       ========================= */
    body {
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    /* Barra de navegación personalizada */
    .navbar-custom {
      background-color: #343a40;
    }
    .navbar-custom .navbar-brand,
    .navbar-custom .nav-link {
      color: #ffffff;
    }
    /* Clase para ocultar secciones */
    .hidden {
      display: none;
    }
    .container-section {
      padding: 20px;
    }
    /* Estilos para la flashcard (modo estudio y repaso) */
    .flashcard-container {
      position: relative;
      margin: 20px auto;
      width: 90%;
      max-width: 600px;
      height: 300px;
      border: 2px solid #343a40;
      border-radius: 10px;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      cursor: pointer;
      overflow: hidden;
      transition: background-color 0.3s, color 0.3s;
    }
    .flashcard-content {
      padding: 20px;
      text-align: center;
      font-size: 1.5em;
    }
    /* Íconos flotantes en la flashcard */
    .flashcard-icons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    .flashcard-icons i {
      font-size: 1.5em;
      cursor: pointer;
      color: #343a40;
    }
    .flashcard-icons i:hover {
      color: #007bff;
    }
    /* Botón de regresar */
    .back-button {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.5em;
      cursor: pointer;
      color: #343a40;
      z-index: 10;
    }
    /* Modo noche: fondos oscuros */
    .night-mode {
      background-color: #343a40 !important;
      color: #fff !important;
    }
    /* Ajustes responsivos */
    @media (max-width: 768px) {
      .flashcard-container {
        height: 250px;
      }
      .flashcard-content {
        font-size: 1.2em;
      }
    }
    /* Contenedor del calendario */
    #calendar {
      max-width: 900px;
      margin: 40px auto;
    }
  </style>
</head>
<body>
  <!-- =============================
       Navegación (Menú Principal)
       ============================= -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="#" id="nav-home">Flashcards App</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="#" id="menu-creacion">Crear Flashcards</a>
          <a class="nav-link" href="#" id="menu-estudio">Estudiar</a>
          <a class="nav-link" href="#" id="menu-repaso">Repasar</a>
          <a class="nav-link" href="#" id="menu-calendario">Planificar Sesiones</a>
        </div>
      </div>
    </div>
  </nav>
  
  <!-- =============================
       Contenedor principal de vistas
       ============================= -->
  <div class="container-section" id="main-content">
  
    <!-- MODO CREACIÓN -->
    <div id="section-creacion" class="hidden">
      <h2>Crear Flashcards</h2>
      <!-- Formulario para crear un bloque nuevo -->
      <div class="mb-3">
        <label for="input-nuevo-asignatura" class="form-label">Asignatura</label>
        <input type="text" class="form-control" id="input-nuevo-asignatura" placeholder="Ej. Matemáticas">
      </div>
      <div class="mb-3">
        <label for="input-nuevo-tema" class="form-label">Tema</label>
        <input type="text" class="form-control" id="input-nuevo-tema" placeholder="Ej. Álgebra">
      </div>
      <div class="mb-3">
        <label for="input-flashcards" class="form-label">Flashcards (formato: línea 1 = pregunta, línea 2 = respuesta, etc.)</label>
        <textarea class="form-control" id="input-flashcards" rows="8" placeholder="Flashcard pregunta 1
Flashcards respuesta 1
Flashcard pregunta 2
Flashcards respuesta 2"></textarea>
      </div>
      <button class="btn btn-primary" id="btn-guardar-flashcards">Guardar Flashcards</button>
      <hr>
      <!-- Sección para agregar flashcards a un bloque ya existente -->
      <h4>Agregar a bloque existente</h4>
      <div class="mb-3">
        <label for="select-asignatura-existente" class="form-label">Asignatura</label>
        <select class="form-select" id="select-asignatura-existente">
          <option value="">Selecciona una asignatura</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="select-tema-existente" class="form-label">Tema</label>
        <select class="form-select" id="select-tema-existente">
          <option value="">Selecciona un tema</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="input-flashcards-agregar" class="form-label">Flashcards (mismo formato)</label>
        <textarea class="form-control" id="input-flashcards-agregar" rows="8"></textarea>
      </div>
      <button class="btn btn-secondary" id="btn-agregar-flashcards">Agregar Flashcards al bloque existente</button>
    </div>
    
    <!-- MODO ESTUDIO -->
    <div id="section-estudio" class="hidden">
      <h2>Estudio de Flashcards</h2>
      <!-- Selección de asignatura y tema -->
      <div id="estudio-seleccion">
        <div id="estudio-asignaturas" class="mb-3">
          <h4>Selecciona Asignatura</h4>
          <ul class="list-group" id="lista-asignaturas-estudio"></ul>
        </div>
        <div id="estudio-temas" class="mb-3 hidden">
          <button class="btn btn-link" id="btn-volver-asignaturas-estudio"><i class="fa fa-arrow-left"></i> Volver a Asignaturas</button>
          <h4>Selecciona Tema</h4>
          <ul class="list-group" id="lista-temas-estudio"></ul>
        </div>
      </div>
      <!-- Área de flashcards en modo estudio -->
      <div id="estudio-flashcards" class="hidden">
        <button class="btn btn-link" id="btn-volver-temas-estudio"><i class="fa fa-arrow-left"></i> Volver a Temas</button>
        <div class="flashcard-container" id="flashcard-container">
          <!-- Botón para salir del modo flashcards -->
          <div class="back-button" id="btn-salir-flashcards"><i class="fa fa-times"></i></div>
          <!-- Íconos flotantes para modo noche y clasificación -->
          <div class="flashcard-icons">
            <i class="fa fa-sun" id="icon-noche" title="Modo Noche"></i>
            <i class="fa fa-smile" id="icon-facil" title="Fácil"></i>
            <i class="fa fa-meh" id="icon-medio" title="Medio"></i>
            <i class="fa fa-frown" id="icon-dificil" title="Difícil"></i>
          </div>
          <div class="flashcard-content" id="flashcard-content">
            <!-- Aquí se mostrará el contenido de la flashcard -->
          </div>
        </div>
        <!-- Botón para pantalla completa (F11) -->
        <button class="btn btn-outline-primary" id="btn-fullscreen">Pantalla Completa</button>
      </div>
    </div>
    
    <!-- MODO REPASO (interfaz similar al modo estudio) -->
    <div id="section-repaso" class="hidden">
      <h2>Repaso de Flashcards</h2>
      <!-- Selección de asignatura, tema y dificultad -->
      <div id="repaso-seleccion">
        <div id="repaso-asignaturas" class="mb-3">
          <h4>Selecciona Asignatura</h4>
          <ul class="list-group" id="lista-asignaturas-repaso"></ul>
        </div>
        <div id="repaso-temas" class="mb-3 hidden">
          <button class="btn btn-link" id="btn-volver-asignaturas-repaso"><i class="fa fa-arrow-left"></i> Volver a Asignaturas</button>
          <h4>Selecciona Tema</h4>
          <ul class="list-group" id="lista-temas-repaso"></ul>
        </div>
        <div id="repaso-dificultad" class="mb-3 hidden">
          <button class="btn btn-link" id="btn-volver-temas-repaso"><i class="fa fa-arrow-left"></i> Volver a Temas</button>
          <h4>Selecciona Dificultad</h4>
          <ul class="list-group" id="lista-dificultad-repaso">
            <li class="list-group-item" data-difficulty="fácil">Fácil</li>
            <li class="list-group-item" data-difficulty="medio">Medio</li>
            <li class="list-group-item" data-difficulty="difícil">Difícil</li>
          </ul>
        </div>
      </div>
      <!-- Área de flashcards en modo repaso -->
      <div id="repaso-flashcards" class="hidden">
        <button class="btn btn-link" id="btn-volver-dificultad-repaso"><i class="fa fa-arrow-left"></i> Volver a Dificultad</button>
        <div class="flashcard-container" id="flashcard-container-repaso">
          <div class="back-button" id="btn-salir-flashcards-repaso"><i class="fa fa-times"></i></div>
          <div class="flashcard-icons">
            <i class="fa fa-sun" id="icon-noche-repaso" title="Modo Noche"></i>
            <i class="fa fa-smile" id="icon-facil-repaso" title="Fácil"></i>
            <i class="fa fa-meh" id="icon-medio-repaso" title="Medio"></i>
            <i class="fa fa-frown" id="icon-dificil-repaso" title="Difícil"></i>
          </div>
          <div class="flashcard-content" id="flashcard-content-repaso">
            <!-- Contenido de la flashcard de repaso -->
          </div>
        </div>
        <button class="btn btn-outline-primary" id="btn-fullscreen-repaso">Pantalla Completa</button>
      </div>
    </div>
    
    <!-- MODO CALENDARIO -->
    <div id="section-calendario" class="hidden">
      <h2>Planificar Sesiones de Repaso</h2>
      <div class="row">
        <div class="col-md-4">
          <h4>Crear Sesión</h4>
          <div class="mb-3">
            <label for="input-sesion-asignatura" class="form-label">Asignatura</label>
            <select class="form-select" id="input-sesion-asignatura">
              <option value="">Selecciona una asignatura</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="input-sesion-tema" class="form-label">Tema</label>
            <select class="form-select" id="input-sesion-tema">
              <option value="">Selecciona un tema</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="input-sesion-dificultad" class="form-label">Dificultad</label>
            <select class="form-select" id="input-sesion-dificultad">
              <option value="">Selecciona dificultad</option>
              <option value="fácil">Fácil</option>
              <option value="medio">Medio</option>
              <option value="difícil">Difícil</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="input-sesion-fecha" class="form-label">Fecha y Hora</label>
            <input type="datetime-local" class="form-control" id="input-sesion-fecha">
          </div>
          <button class="btn btn-primary" id="btn-crear-sesion">Crear Sesión</button>
        </div>
        <div class="col-md-8">
          <h4>Calendario de Sesiones</h4>
          <div id="calendar"></div>
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- =============================
       Librerías JavaScript
       ============================= -->
  <!-- Bootstrap Bundle (incluye Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  
  <script>
  /***********************************************
   * FLASHCARDS APP - Lógica y Manejo de Datos
   ***********************************************/
  
  // Objeto principal de la aplicación con datos, sesiones y estado
  const app = {
    data: {
      // Estructura: { "Asignatura": { themes: { "Tema": [flashcard, ...] } } }
      subjects: {}
    },
    sessions: [], // Sesiones de repaso planificadas
    state: {
      currentMode: null,  // 'creacion', 'estudio', 'repaso', 'calendario'
      selectedSubject: null,
      selectedTheme: null,
      selectedDifficulty: null,
      flashcards: [],
      currentCardIndex: 0,
      nightMode: false
    }
  };
  
  // Función para generar un ID único
  function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9);
  }
  
  // Cargar datos y sesiones desde LocalStorage
  function loadData() {
    const storedData = localStorage.getItem('flashcardsData');
    if (storedData) {
      app.data = JSON.parse(storedData);
    }
    const storedSessions = localStorage.getItem('flashcardSessions');
    if (storedSessions) {
      app.sessions = JSON.parse(storedSessions);
    }
  }
  
  // Guardar datos y sesiones en LocalStorage
  function saveData() {
    localStorage.setItem('flashcardsData', JSON.stringify(app.data));
    localStorage.setItem('flashcardSessions', JSON.stringify(app.sessions));
  }
  
  // Mostrar solo la sección indicada y ocultar las demás
  function showSection(sectionId) {
    const sections = ['section-creacion', 'section-estudio', 'section-repaso', 'section-calendario'];
    sections.forEach(id => {
      document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(sectionId).classList.remove('hidden');
    // Actualiza el modo actual
    if(sectionId === 'section-creacion') app.state.currentMode = 'creacion';
    else if(sectionId === 'section-estudio') app.state.currentMode = 'estudio';
    else if(sectionId === 'section-repaso') app.state.currentMode = 'repaso';
    else if(sectionId === 'section-calendario') app.state.currentMode = 'calendario';
  }
  
  // Inicialización de la aplicación
  function init() {
    loadData();
    bindNavEvents();
    renderAsignaturasDropdowns();
    // Por defecto se muestra el modo creación
    showSection('section-creacion');
  }
  
  // Enlazar eventos del menú de navegación
  function bindNavEvents() {
    document.getElementById('menu-creacion').addEventListener('click', () => {
      showSection('section-creacion');
      renderAsignaturasDropdowns();
    });
    document.getElementById('menu-estudio').addEventListener('click', () => {
      showSection('section-estudio');
      renderEstudioAsignaturas();
    });
    document.getElementById('menu-repaso').addEventListener('click', () => {
      showSection('section-repaso');
      renderRepasoAsignaturas();
    });
    document.getElementById('menu-calendario').addEventListener('click', () => {
      showSection('section-calendario');
      renderCalendario();
      renderAsignaturasDropdowns();
    });
    document.getElementById('nav-home').addEventListener('click', () => {
      showSection('section-creacion');
      renderAsignaturasDropdowns();
    });
  }
  
  /***********************
   * MODO CREACIÓN
   ***********************/
  
  // Guardar un nuevo bloque de flashcards
  document.getElementById('btn-guardar-flashcards').addEventListener('click', () => {
    const subject = document.getElementById('input-nuevo-asignatura').value.trim();
    const theme = document.getElementById('input-nuevo-tema').value.trim();
    const text = document.getElementById('input-flashcards').value.trim();
    if (!subject || !theme || !text) {
      alert('Por favor, complete todos los campos.');
      return;
    }
    // Crear la estructura en caso de que no exista
    if (!app.data.subjects[subject]) {
      app.data.subjects[subject] = { themes: {} };
    }
    if (!app.data.subjects[subject].themes[theme]) {
      app.data.subjects[subject].themes[theme] = [];
    }
    // Parsear el textarea (cada 2 líneas = pregunta y respuesta)
    const lines = text.split('\n').filter(line => line.trim() !== '');
    for (let i = 0; i < lines.length; i += 2) {
      const question = lines[i];
      const answer = lines[i+1] || '';
      const flashcard = {
        id: generateId(),
        question: question,
        answer: answer,
        difficulty: null
      };
      app.data.subjects[subject].themes[theme].push(flashcard);
    }
    saveData();
    alert('Flashcards guardadas correctamente.');
    // Limpiar campos
    document.getElementById('input-nuevo-asignatura').value = '';
    document.getElementById('input-nuevo-tema').value = '';
    document.getElementById('input-flashcards').value = '';
    renderAsignaturasDropdowns();
  });
  
  // Agregar flashcards a un bloque existente
  document.getElementById('btn-agregar-flashcards').addEventListener('click', () => {
    const subject = document.getElementById('select-asignatura-existente').value;
    const theme = document.getElementById('select-tema-existente').value;
    const text = document.getElementById('input-flashcards-agregar').value.trim();
    if (!subject || !theme || !text) {
      alert('Por favor, complete todos los campos para agregar flashcards.');
      return;
    }
    if (!app.data.subjects[subject] || !app.data.subjects[subject].themes[theme]) {
      alert('El bloque seleccionado no existe.');
      return;
    }
    const lines = text.split('\n').filter(line => line.trim() !== '');
    for (let i = 0; i < lines.length; i += 2) {
      const question = lines[i];
      const answer = lines[i+1] || '';
      const flashcard = {
        id: generateId(),
        question: question,
        answer: answer,
        difficulty: null
      };
      app.data.subjects[subject].themes[theme].push(flashcard);
    }
    saveData();
    alert('Flashcards agregadas correctamente.');
    document.getElementById('input-flashcards-agregar').value = '';
  });
  
  // Renderizar asignaturas en los dropdowns (para creación y calendario)
  function renderAsignaturasDropdowns() {
    const asignaturasSelects = ['select-asignatura-existente', 'input-sesion-asignatura'];
    asignaturasSelects.forEach(selectId => {
      const selectElem = document.getElementById(selectId);
      selectElem.innerHTML = '<option value="">Selecciona una asignatura</option>';
      Object.keys(app.data.subjects).forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        selectElem.appendChild(option);
      });
    });
  }
  
  // Actualizar los temas en el dropdown cuando se selecciona una asignatura (modo creación)
  document.getElementById('select-asignatura-existente').addEventListener('change', (e) => {
    const subject = e.target.value;
    const temasSelect = document.getElementById('select-tema-existente');
    temasSelect.innerHTML = '<option value="">Selecciona un tema</option>';
    if (subject && app.data.subjects[subject]) {
      Object.keys(app.data.subjects[subject].themes).forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        option.textContent = theme;
        temasSelect.appendChild(option);
      });
    }
  });
  
  // Actualizar los temas en el formulario de sesión (modo calendario)
  document.getElementById('input-sesion-asignatura').addEventListener('change', (e) => {
    const subject = e.target.value;
    const temasSelect = document.getElementById('input-sesion-tema');
    temasSelect.innerHTML = '<option value="">Selecciona un tema</option>';
    if (subject && app.data.subjects[subject]) {
      Object.keys(app.data.subjects[subject].themes).forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        option.textContent = theme;
        temasSelect.appendChild(option);
      });
    }
  });
  
  /***********************
   * MODO ESTUDIO
   ***********************/
  
  // Renderizar la lista de asignaturas para estudio
  function renderEstudioAsignaturas() {
    const lista = document.getElementById('lista-asignaturas-estudio');
    lista.innerHTML = '';
    Object.keys(app.data.subjects).forEach(subject => {
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action';
      li.textContent = subject;
      li.addEventListener('click', () => {
        app.state.selectedSubject = subject;
        renderEstudioTemas(subject);
      });
      lista.appendChild(li);
    });
  }
  
  // Renderizar la lista de temas para la asignatura seleccionada en estudio
  function renderEstudioTemas(subject) {
    document.getElementById('estudio-asignaturas').classList.add('hidden');
    const temasDiv = document.getElementById('estudio-temas');
    temasDiv.classList.remove('hidden');
    const lista = document.getElementById('lista-temas-estudio');
    lista.innerHTML = '';
    Object.keys(app.data.subjects[subject].themes).forEach(theme => {
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action';
      li.textContent = theme;
      li.addEventListener('click', () => {
        app.state.selectedTheme = theme;
        app.state.flashcards = app.data.subjects[app.state.selectedSubject].themes[theme];
        app.state.currentCardIndex = 0;
        renderFlashcardEstudio();
      });
      lista.appendChild(li);
    });
  }
  
  // Botón para volver a la selección de asignaturas en estudio
  document.getElementById('btn-volver-asignaturas-estudio').addEventListener('click', () => {
    document.getElementById('estudio-temas').classList.add('hidden');
    document.getElementById('estudio-asignaturas').classList.remove('hidden');
  });
  
  // Botón para volver a la selección de temas desde el modo flashcards (estudio)
  document.getElementById('btn-volver-temas-estudio').addEventListener('click', () => {
    document.getElementById('estudio-flashcards').classList.add('hidden');
    document.getElementById('estudio-temas').classList.remove('hidden');
  });
  
  // Botón para salir del modo flashcards en estudio
  document.getElementById('btn-salir-flashcards').addEventListener('click', () => {
    document.getElementById('estudio-flashcards').classList.add('hidden');
    document.getElementById('estudio-temas').classList.remove('hidden');
  });
  
  // Renderizar la flashcard actual en modo estudio
  function renderFlashcardEstudio() {
    if (app.state.flashcards.length === 0) {
      alert('No hay flashcards en este tema.');
      return;
    }
    document.getElementById('estudio-temas').classList.add('hidden');
    document.getElementById('estudio-flashcards').classList.remove('hidden');
    updateFlashcardContent('question');
  }
  
  // Actualizar el contenido (pregunta/respuesta) de la flashcard en estudio
  // face: 'question' o 'answer'
  function updateFlashcardContent(face) {
    const container = document.getElementById('flashcard-container');
    const contentDiv = document.getElementById('flashcard-content');
    const currentFlashcard = app.state.flashcards[app.state.currentCardIndex];
    if (!currentFlashcard) return;
    contentDiv.textContent = currentFlashcard[face];
    container.setAttribute('data-face', face);
  }
  
  // Manejo del clic en la flashcard (modo estudio): según la posición se cambia la cara o se pasa a otra tarjeta
  document.getElementById('flashcard-container').addEventListener('click', (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const face = e.currentTarget.getAttribute('data-face') || 'question';
    // Para escritorio: si el clic se da en los costados se cambia la cara; en los bordes verticales se navega entre tarjetas
    if(window.innerWidth > 768) {
      if(x < rect.width * 0.2 || x > rect.width * 0.8) {
        const newFace = (face === 'question') ? 'answer' : 'question';
        updateFlashcardContent(newFace);
      } else if(y < rect.height * 0.2 || y > rect.height * 0.8) {
        navigateFlashcardEstudio();
      }
    } else {
      // En móviles, un clic cambia la cara
      const newFace = (face === 'question') ? 'answer' : 'question';
      updateFlashcardContent(newFace);
    }
  });
  
  // Navegar a la siguiente flashcard en modo estudio
  function navigateFlashcardEstudio() {
    app.state.currentCardIndex = (app.state.currentCardIndex + 1) % app.state.flashcards.length;
    updateFlashcardContent('question');
  }
  
  // Detección de swipe en móviles (modo estudio)
  let touchStartY = null;
  document.getElementById('flashcard-container').addEventListener('touchstart', (e) => {
    touchStartY = e.changedTouches[0].clientY;
  });
  document.getElementById('flashcard-container').addEventListener('touchend', (e) => {
    if(touchStartY === null) return;
    const touchEndY = e.changedTouches[0].clientY;
    if(Math.abs(touchStartY - touchEndY) > 50) {
      navigateFlashcardEstudio();
    }
    touchStartY = null;
  });
  
  // Botones para clasificar la flashcard (modo estudio)
  document.getElementById('icon-facil').addEventListener('click', () => {
    setFlashcardDifficulty('fácil');
  });
  document.getElementById('icon-medio').addEventListener('click', () => {
    setFlashcardDifficulty('medio');
  });
  document.getElementById('icon-dificil').addEventListener('click', () => {
    setFlashcardDifficulty('difícil');
  });
  
  // Asignar dificultad a la flashcard actual y guardar en LocalStorage
  function setFlashcardDifficulty(level) {
    const currentFlashcard = app.state.flashcards[app.state.currentCardIndex];
    if(currentFlashcard) {
      currentFlashcard.difficulty = level;
      saveData();
      alert('Flashcard clasificada como ' + level);
    }
  }
  
  // Modo noche en estudio
  document.getElementById('icon-noche').addEventListener('click', () => {
    toggleNightMode('estudio');
  });
  
  // Pantalla completa en estudio
  document.getElementById('btn-fullscreen').addEventListener('click', () => {
    toggleFullScreen(document.getElementById('flashcard-container'));
  });
  
  // Alternar modo noche aplicando o removiendo la clase 'night-mode'
  function toggleNightMode(mode) {
    if(mode === 'estudio') {
      const container = document.getElementById('flashcard-container');
      app.state.nightMode = !app.state.nightMode;
      container.classList.toggle('night-mode', app.state.nightMode);
    } else if(mode === 'repaso') {
      const container = document.getElementById('flashcard-container-repaso');
      app.state.nightMode = !app.state.nightMode;
      container.classList.toggle('night-mode', app.state.nightMode);
    }
  }
  
  // Activar o salir del modo pantalla completa
  function toggleFullScreen(elem) {
    if (!document.fullscreenElement) {
      elem.requestFullscreen().catch(err => {
        alert(`Error al activar pantalla completa: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }
  
  /***********************
   * MODO REPASO
   ***********************/
  
  // Renderizar asignaturas para repaso
  function renderRepasoAsignaturas() {
    const lista = document.getElementById('lista-asignaturas-repaso');
    lista.innerHTML = '';
    Object.keys(app.data.subjects).forEach(subject => {
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action';
      li.textContent = subject;
      li.addEventListener('click', () => {
        app.state.selectedSubject = subject;
        renderRepasoTemas(subject);
      });
      lista.appendChild(li);
    });
  }
  
  // Renderizar temas para repaso
  function renderRepasoTemas(subject) {
    document.getElementById('repaso-asignaturas').classList.add('hidden');
    const temasDiv = document.getElementById('repaso-temas');
    temasDiv.classList.remove('hidden');
    const lista = document.getElementById('lista-temas-repaso');
    lista.innerHTML = '';
    Object.keys(app.data.subjects[subject].themes).forEach(theme => {
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action';
      li.textContent = theme;
      li.addEventListener('click', () => {
        app.state.selectedTheme = theme;
        // Mostrar selección de dificultad en repaso
        document.getElementById('repaso-dificultad').classList.remove('hidden');
      });
      lista.appendChild(li);
    });
  }
  
  // Botones para volver en repaso
  document.getElementById('btn-volver-asignaturas-repaso').addEventListener('click', () => {
    document.getElementById('repaso-temas').classList.add('hidden');
    document.getElementById('repaso-asignaturas').classList.remove('hidden');
  });
  document.getElementById('btn-volver-temas-repaso').addEventListener('click', () => {
    document.getElementById('repaso-dificultad').classList.add('hidden');
    document.getElementById('repaso-temas').classList.remove('hidden');
  });
  document.getElementById('btn-volver-dificultad-repaso').addEventListener('click', () => {
    document.getElementById('repaso-flashcards').classList.add('hidden');
    document.getElementById('repaso-dificultad').classList.remove('hidden');
  });
  
  // Selección de dificultad (lista de ítems) en repaso
  document.getElementById('lista-dificultad-repaso').addEventListener('click', (e) => {
    if(e.target && e.target.matches('li')) {
      const difficulty = e.target.getAttribute('data-difficulty');
      app.state.selectedDifficulty = difficulty;
      // Filtrar flashcards según la dificultad seleccionada
      const allFlashcards = app.data.subjects[app.state.selectedSubject].themes[app.state.selectedTheme];
      app.state.flashcards = allFlashcards.filter(fc => fc.difficulty === difficulty);
      app.state.currentCardIndex = 0;
      if(app.state.flashcards.length === 0) {
        alert('No hay flashcards con esa clasificación.');
        return;
      }
      document.getElementById('repaso-dificultad').classList.add('hidden');
      document.getElementById('repaso-flashcards').classList.remove('hidden');
      updateFlashcardContentRepaso('question');
    }
  });
  
  // Actualizar el contenido de la flashcard en repaso
  function updateFlashcardContentRepaso(face) {
    const container = document.getElementById('flashcard-container-repaso');
    const contentDiv = document.getElementById('flashcard-content-repaso');
    const currentFlashcard = app.state.flashcards[app.state.currentCardIndex];
    if (!currentFlashcard) return;
    contentDiv.textContent = currentFlashcard[face];
    container.setAttribute('data-face', face);
  }
  
  // Manejo de clics en la flashcard (modo repaso)
  document.getElementById('flashcard-container-repaso').addEventListener('click', (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const face = e.currentTarget.getAttribute('data-face') || 'question';
    if(window.innerWidth > 768) {
      if(x < rect.width * 0.2 || x > rect.width * 0.2) {
        const newFace = (face === 'question') ? 'answer' : 'question';
        updateFlashcardContentRepaso(newFace);
      } else if(y < rect.height * 0.2 || y > rect.height * 0.8) {
        navigateFlashcardRepaso();
      }
    } else {
      const newFace = (face === 'question') ? 'answer' : 'question';
      updateFlashcardContentRepaso(newFace);
    }
  });
  
  // Navegar entre flashcards en repaso
  function navigateFlashcardRepaso() {
    app.state.currentCardIndex = (app.state.currentCardIndex + 1) % app.state.flashcards.length;
    updateFlashcardContentRepaso('question');
  }
  
  // Detección de swipe en móviles para repaso
  let touchStartYRepaso = null;
  document.getElementById('flashcard-container-repaso').addEventListener('touchstart', (e) => {
    touchStartYRepaso = e.changedTouches[0].clientY;
  });
  document.getElementById('flashcard-container-repaso').addEventListener('touchend', (e) => {
    if(touchStartYRepaso === null) return;
    const touchEndY = e.changedTouches[0].clientY;
    if(Math.abs(touchStartYRepaso - touchEndY) > 50) {
      navigateFlashcardRepaso();
    }
    touchStartYRepaso = null;
  });
  
  // Botones de clasificación en repaso
  document.getElementById('icon-facil-repaso').addEventListener('click', () => {
    setFlashcardDifficultyRepaso('fácil');
  });
  document.getElementById('icon-medio-repaso').addEventListener('click', () => {
    setFlashcardDifficultyRepaso('medio');
  });
  document.getElementById('icon-dificil-repaso').addEventListener('click', () => {
    setFlashcardDifficultyRepaso('difícil');
  });
  
  function setFlashcardDifficultyRepaso(level) {
    const currentFlashcard = app.state.flashcards[app.state.currentCardIndex];
    if(currentFlashcard) {
      currentFlashcard.difficulty = level;
      saveData();
      alert('Flashcard reclasificada como ' + level);
    }
  }
  
  // Modo noche en repaso
  document.getElementById('icon-noche-repaso').addEventListener('click', () => {
    toggleNightMode('repaso');
  });
  
  // Pantalla completa en repaso
  document.getElementById('btn-fullscreen-repaso').addEventListener('click', () => {
    toggleFullScreen(document.getElementById('flashcard-container-repaso'));
  });
  
  /***********************
   * MODO CALENDARIO
   ***********************/
  
  // Crear sesión de repaso y guardarla en LocalStorage
  document.getElementById('btn-crear-sesion').addEventListener('click', () => {
    const subject = document.getElementById('input-sesion-asignatura').value;
    const theme = document.getElementById('input-sesion-tema').value;
    const difficulty = document.getElementById('input-sesion-dificultad').value;
    const datetime = document.getElementById('input-sesion-fecha').value;
    if(!subject || !theme || !difficulty || !datetime) {
      alert('Por favor, complete todos los campos para crear la sesión.');
      return;
    }
    const session = {
      id: generateId(),
      subject: subject,
      theme: theme,
      difficulty: difficulty,
      datetime: datetime
    };
    app.sessions.push(session);
    saveData();
    alert('Sesión creada correctamente.');
    // Reiniciar formulario
    document.getElementById('input-sesion-asignatura').value = '';
    document.getElementById('input-sesion-tema').innerHTML = '<option value="">Selecciona un tema</option>';
    document.getElementById('input-sesion-dificultad').value = '';
    document.getElementById('input-sesion-fecha').value = '';
    renderCalendario();
  });
  
  // Renderizar el calendario usando FullCalendar
  function renderCalendario() {
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = ''; // Limpiar contenido anterior
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 500,
      events: app.sessions.map(session => ({
        id: session.id,
        title: session.subject + ' - ' + session.theme + ' (' + session.difficulty + ')',
        start: session.datetime
      })),
      eventClick: function(info) {
        // Al hacer clic en una sesión, se carga el mazo en modo repaso filtrado por la dificultad de la sesión
        const sessionId = info.event.id;
        const session = app.sessions.find(s => s.id === sessionId);
        if(session) {
          showSection('section-repaso');
          app.state.selectedSubject = session.subject;
          app.state.selectedTheme = session.theme;
          app.state.selectedDifficulty = session.difficulty;
          const allFlashcards = app.data.subjects[session.subject].themes[session.theme];
          app.state.flashcards = allFlashcards.filter(fc => fc.difficulty === session.difficulty);
          app.state.currentCardIndex = 0;
          document.getElementById('repaso-asignaturas').classList.add('hidden');
          document.getElementById('repaso-temas').classList.add('hidden');
          document.getElementById('repaso-dificultad').classList.add('hidden');
          document.getElementById('repaso-flashcards').classList.remove('hidden');
          updateFlashcardContentRepaso('question');
        }
      }
    });
    calendar.render();
  }
  
  // Inicializar la aplicación al cargar el DOM
  document.addEventListener('DOMContentLoaded', init);
  
  </script>
</body>
</html>
